<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="dns-prefetch" href="https://blog.xxwhite.com"><link rel="preconnect" href="//cdn.jsdelivr.net"><title>BiliBili弹幕解析 | 叉叉白</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="简单说一下我开发的弹幕后端的 BiliBili 弹幕解析过程，总结一下以前犯得新手错误，我的程序不是能用就行，我在能用的情况下还要有效率。"><meta property="og:type" content="article"><meta property="og:title" content="BiliBili弹幕解析"><meta property="og:url" content="https://blog.xxwhite.com/2020/bilibili-danmaku.html"><meta property="og:site_name" content="叉叉白"><meta property="og:description" content="简单说一下我开发的弹幕后端的 BiliBili 弹幕解析过程，总结一下以前犯得新手错误，我的程序不是能用就行，我在能用的情况下还要有效率。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.xxwhite.com/assets/img/2020/Snipaste_2020-02-23_15-25-59.png"><meta property="og:image" content="https://blog.xxwhite.com/assets/img/2020/Snipaste_2020-02-23_15-28-04.png"><meta property="og:image" content="https://blog.xxwhite.com/assets/img/2020/Snipaste_2020-02-23_16-09-27.png"><meta property="og:image" content="https://blog.xxwhite.com/assets/img/2020/Snipaste_2020-02-23_18-32-51.png"><meta property="article:published_time" content="2020-02-23T14:58:35.000Z"><meta property="article:modified_time" content="2021-03-25T02:35:30.816Z"><meta property="article:author" content="MonoLogueChi"><meta property="article:tag" content="C#"><meta property="article:tag" content="dotnet"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.xxwhite.com/assets/img/2020/Snipaste_2020-02-23_15-25-59.png"><link rel="alternative" href="/atom.xml" title="叉叉白" type="application/atom+xml"><link rel="icon" href="/assets/img/favicon.png"><link rel="stylesheet" href="/assets/./main.18a6af.css"><style type="text/css">#container.show{background:linear-gradient(200deg,#a0cfe4,#e8c37e)}</style><script>function loadScript(e,t){d=document,o=d.createElement("script"),s=d.getElementsByTagName("head")[0].appendChild(o),o.setAttribute("src",e),t&&o.addEventListener("load",function(e){t(e)}),s.parentNode.insertBefore(o,s)}</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="container" q-class="show:isCtnShow"><canvas id="anm-canvas" class="anm-canvas"></canvas><div class="left-col" q-class="show:isShow"><div class="overlay" style="background:#4d4d4d"></div><div class="intrude-less"><header id="header" class="inner"><a href="" class="profilepic"><img src="/assets/img/avatar.jpg" class="js-avatar"></a><hgroup><h1 class="header-author"><a href=""></a></h1></hgroup><nav class="header-menu"><ul><li><a href="/">主页</a></li><li><a href="/tags/%E6%90%9E%E6%9C%BA/">搞机</a></li><li><a href="/MessageBoard/">留言</a></li><li><a href="/aboutme/">关于</a></li><li><a href="/tags/%E5%BB%BA%E7%AB%99%E7%AC%94%E8%AE%B0/">笔记</a></li><li><a href="/tags/timeline/">时光</a></li></ul></nav><nav class="header-smart-menu"><a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)" target="_self">所有文章</a> <a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)" target="_self">友链</a> <a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)" target="_self">关于本站</a></nav><nav class="header-nav"><div class="social"><a class="rss" target="_blank" href="/atom.xml" title="rss"><i class="icon-rss"></i></a> <a class="github" target="_blank" href="https://github.com/MonoLogueChi" title="github"><i class="icon-github"></i></a> <a class="qq" target="_blank" href="/assets/html/qq-groups.html" title="qq"><i class="icon-qq"></i></a> <a class="bilibili" target="_blank" href="https://space.bilibili.com/28474682/" title="bilibili"><i class="icon-bilibili"></i></a> <a class="mail" target="_blank" href="mailto:xxwhite@foxmail.com" title="mail"><i class="icon-mail"></i></a></div></nav></header></div></div><div class="mid-col" q-class="show:isShow,hide:isShow|isFalse"><nav id="mobile-nav"><div class="overlay js-overlay" style="background:#4d4d4d"></div><div class="btnctn js-mobile-btnctn"><div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div></div><div class="intrude-less"><header id="header" class="inner"><div class="profilepic"><a href="/"><img src="/assets/img/avatar.jpg" class="js-avatar"></a></div><hgroup><h1 class="header-author js-header-author"></h1></hgroup><nav class="header-nav"><div class="social"><a class="rss" target="_blank" href="/atom.xml" title="rss"><i class="icon-rss"></i></a> <a class="github" target="_blank" href="https://github.com/MonoLogueChi" title="github"><i class="icon-github"></i></a> <a class="qq" target="_blank" href="/assets/html/qq-groups.html" title="qq"><i class="icon-qq"></i></a> <a class="bilibili" target="_blank" href="https://space.bilibili.com/28474682/" title="bilibili"><i class="icon-bilibili"></i></a> <a class="mail" target="_blank" href="mailto:xxwhite@foxmail.com" title="mail"><i class="icon-mail"></i></a></div></nav><nav class="header-menu js-header-menu"><ul style="width:70%"><li style="width:16.666666666666668%"><a href="/">主页</a></li><li style="width:16.666666666666668%"><a href="/tags/%E6%90%9E%E6%9C%BA/">搞机</a></li><li style="width:16.666666666666668%"><a href="/MessageBoard/">留言</a></li><li style="width:16.666666666666668%"><a href="/aboutme/">关于</a></li><li style="width:16.666666666666668%"><a href="/tags/%E5%BB%BA%E7%AB%99%E7%AC%94%E8%AE%B0/">笔记</a></li><li style="width:16.666666666666668%"><a href="/tags/timeline/">时光</a></li></ul></nav></header></div><div class="mobile-mask" style="display:none" q-show="isShow"></div></nav><div id="wrapper" class="body-wrap"><div class="menu-l"><div class="canvas-wrap"><canvas data-colors="#eaeaea" data-sectionheight="100" data-contentid="js-content" id="myCanvas1" class="anm-canvas"></canvas></div><div id="js-content" class="content-ll"><article id="post-2020/bilibili-danmaku" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">BiliBili弹幕解析</h1><a href="/2020/bilibili-danmaku.html" class="archive-article-date"><time datetime="2020-02-23T14:58:35.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-02-23</time></a></header><div class="article-entry" itemprop="articleBody"><p>简单说一下我开发的<a target="_blank" rel="noopener" href="https://github.com/MonoLogueChi/Dplayer.Danmaku">弹幕后端</a>的 BiliBili 弹幕解析过程，总结一下以前犯得新手错误，我的程序不是能用就行，我在能用的情况下还要有效率。</p><span id="more"></span><blockquote><p>超长文章预警，附带解题思路</p></blockquote><h2 id="B-站弹幕接口">B 站弹幕接口<a class="header-anchor" href="#B-站弹幕接口">➴</a></h2><p>目前我用的 B 站弹幕接口有：</p><ul><li><code>https://api.bilibili.com/x/v1/dm/list.so?oid=&#123;cid&#125;</code></li><li><code>https://api.bilibili.com/x/v2/dm/history?type=1&amp;oid=&#123;cid&#125;&amp;date=&#123;date&#125;</code></li></ul><p>第一个用于查询弹幕，第二个是查询历史弹幕。</p><p>关于历史弹幕这里要说一点，有些视频弹幕过多，默认只会显示最近的一部分弹幕，过多的都会在历史弹幕里面，但是历史弹幕的接口需要登录，后面会说登录的事。</p><p>查询弹幕的 cid 以前可以在分享里看的，现在好像是给隐藏掉了，不过幸好还有查询 cid 的接口</p><ul><li><code>https://www.bilibili.com/widget/getPageList?aid=&#123;aid&#125;</code></li></ul><p>上面的这个接口可以使用 av 号查询 cid。</p><p>前面三个接口先在浏览器里看一下，如果我不说下面这几个坑，没有爬虫经验的 C# 程序猿没准都不知道怎么解决</p><p><a target="_blank" rel="noopener" href="https://api.bilibili.com/x/v1/dm/list.so?oid=1176840">https://api.bilibili.com/x/v1/dm/list.so?oid=1176840</a></p><p><img src="/assets/img/2020/Snipaste_2020-02-23_15-25-59.png" alt=""></p><p>注意一下，压缩算法是 <code>deflate</code>，编码 <code>UTF-8</code>，这里我踩过坑，压缩算法先看好了。</p><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/widget/getPageList?aid=810872">https://www.bilibili.com/widget/getPageList?aid=810872</a></p><p><img src="/assets/img/2020/Snipaste_2020-02-23_15-28-04.png" alt=""></p><p>注意，压缩算法是 <code>gzip</code>，编码 <code>UTF-8</code>。</p><h2 id="Http-请求">Http 请求<a class="header-anchor" href="#Http-请求">➴</a></h2><h3 id="基础">基础<a class="header-anchor" href="#基础">➴</a></h3><p>先使用最简单的方法获取数据，跑通了再优化。</p><p>可以参考这篇<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/csharp/tutorials/console-webapiclient">文档</a></p><p>使用 .net core 版本为 3.1。</p><figure class="highlight cs"><figcaption><span>BiliBiliDanmakuController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BiliBili.Danmaku.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">&quot;api/danmaku&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BiliBiliDanmakuController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">HttpGet(<span class="meta-string">&quot;v1&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetV1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> client = <span class="keyword">new</span> HttpClient();</span><br><span class="line">            <span class="keyword">var</span> a = client.GetStringAsync(<span class="string">&quot;https://api.bilibili.com/x/v1/dm/list.so?oid=1176840&quot;</span>).Result;</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面写的代码是中规中矩，看上去可以，但是一运行就会出问题。</p><p><img src="/assets/img/2020/Snipaste_2020-02-23_16-09-27.png" alt=""></p><p>解析出来的全都是乱码，为什么会这样呢？还记得上面说的压缩算法吗？</p><p>这个时候就有几种不同的解决思路了，我先说一下我最开始的解决思路，先用 <code>GetStreamAsync()</code> 直接获取数据流，然后再写一个解压方法，使用 <code>deflate</code> 算法解压数据流。</p><figure class="highlight cs"><figcaption><span>BiliBiliDanmakuController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.IO.Compression;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BiliBili.Danmaku.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">&quot;api/danmaku&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BiliBiliDanmakuController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">HttpGet(<span class="meta-string">&quot;v1&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetV1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> client = <span class="keyword">new</span> HttpClient();</span><br><span class="line">            <span class="keyword">var</span> a = client.GetStreamAsync(<span class="string">&quot;https://api.bilibili.com/x/v1/dm/list.so?oid=1176840&quot;</span>).Result;</span><br><span class="line">            <span class="keyword">return</span> DeDeflate(a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">DeDeflate</span>(<span class="params">Stream s</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> gZipStream = <span class="keyword">new</span> DeflateStream(s, CompressionMode.Decompress);</span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> reader = <span class="keyword">new</span> StreamReader(gZipStream);</span><br><span class="line">            <span class="keyword">return</span> reader.ReadToEndAsync().Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我最开始用的是 <code>WebClient</code>，和 <code>HttpClient</code> 差不多，思路是一样。</p><p>上面的代码只能说能用，下面说一下另一种方法，也是我现在采用的方法。</p><p>从<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.net.http.httpclienthandler?view=netcore-3.1">相关文档</a>了解到，可以使用下面的方法</p><figure class="highlight cs"><figcaption><span>BiliBiliDanmakuController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BiliBili.Danmaku.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">&quot;api/danmaku&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BiliBiliDanmakuController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">HttpGet(<span class="meta-string">&quot;v1&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetV1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> handler = <span class="keyword">new</span> HttpClientHandler &#123;AutomaticDecompression = DecompressionMethods.Deflate&#125;;</span><br><span class="line">            <span class="keyword">var</span> client = <span class="keyword">new</span> HttpClient(handler);</span><br><span class="line">            <span class="keyword">var</span> a = client.GetStringAsync(<span class="string">&quot;https://api.bilibili.com/x/v1/dm/list.so?oid=1176840&quot;</span>).Result;</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cid 的查询接口使用的压缩算法是 gzip，处理方式类似，就不再赘述了。</p><h3 id="优化">优化<a class="header-anchor" href="#优化">➴</a></h3><p>前面只是能跑通了，但是并没有涉及到优化的问题。</p><p>首先是关于 <code>HttpClientHandler</code> 的问题，从<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.net.http.socketshttphandler?view=netcore-3.1">相关文档</a>了解到，.net core 2.1 以后，使用 <code>SocketsHttpHandler</code> 代替处理。</p><p>接下来还有<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/architecture/microservices/implement-resilient-applications/use-httpclientfactory-to-implement-resilient-http-requests">其他问题</a>。</p><blockquote><p>常见的原始 HttpClient 类非常易于使用，但在某些情况下，许多开发人员却并未正确使用该类。第一个问题，当此类可释放时，将其用于 using 语句并不是最佳选择，因为即使释放 HttpClient 对象，基础套接字也不会立即释放，并可能导致严重问题：“套接字耗尽”。 有关此问题的详细信息，请参阅你正在以错误方式使用 HttpClient，这将导致软件受损博客文章。因此，HttpClient 应进行一次实例化并在应用程序的生命周期中重复使用。 在负载较重的情况下，实例化每个请求的 HttpClient 类将耗尽可用的套接字数。 该问题会导致 SocketException 错误。 要解决此问题，可能的方法是将 HttpClient 对象创建为单一对象或静态对象，请参阅关于 HttpClient 用法的 Microsoft 文章中的说明。但将 HttpClient 对象用作单一对象或静态对象时还有一个问题。 在这种情况下，单一实例或静态 HttpClient 不考虑 DNS 更改，请参阅 dotnet/corefx GitHub 存储库中的此问题中的说明。为解决上述问题并使 HttpClient 实例管理更轻松，.NET Core 2.1 引入了新的 HttpClientFactory，后者可与 Polly 集成来实现弹性 HTTP 调用。</p></blockquote><p>说实话，看微软的文档是真的难受，要不是有人找出来，完全不知道该怎么看。</p><p>可以优化成下面这样的程序</p><figure class="highlight cs"><figcaption><span>BiliBiliDanmakuController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BiliBili.Danmaku.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">&quot;api/danmaku&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BiliBiliDanmakuController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> HttpClientHandler Handler =</span><br><span class="line">                <span class="keyword">new</span> HttpClientHandler &#123; AutomaticDecompression = DecompressionMethods.Deflate &#125;;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> HttpClient Client = <span class="keyword">new</span> HttpClient(Handler);</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet(<span class="meta-string">&quot;v1&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetV1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> a = Client.GetStringAsync(<span class="string">&quot;https://api.bilibili.com/x/v1/dm/list.so?oid=1176840&quot;</span>).Result;</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再根据<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/http-requests?view=aspnetcore-3.1">相关文档</a>，可以这样做，修改 <code>Startup.cs</code> 。</p><figure class="highlight cs"><figcaption><span>Startup.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    services.AddControllers();</span><br><span class="line">    services.AddHttpClient(<span class="string">&quot;deflate&quot;</span>).ConfigurePrimaryHttpMessageHandler(() =&gt;</span><br><span class="line">        <span class="keyword">new</span> SocketsHttpHandler &#123; AutomaticDecompression = DecompressionMethods.Deflate &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就可以写</p><figure class="highlight cs"><figcaption><span>BiliBiliDanmakuController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BiliBili.Danmaku.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">&quot;api/danmaku&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BiliBiliDanmakuController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> HttpClient _client;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BiliBiliDanmakuController</span>(<span class="params">IHttpClientFactory httpClientFactory</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _client = httpClientFactory.CreateClient(<span class="string">&quot;deflate&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet(<span class="meta-string">&quot;v1&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetV1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> a = _client.GetStringAsync(<span class="string">&quot;https://api.bilibili.com/x/v1/dm/list.so?oid=1176840&quot;</span>).Result;</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者是用以下的解决方式，<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/architecture/microservices/implement-resilient-applications/use-httpclientfactory-to-implement-resilient-http-requests">文档</a></p><figure class="highlight cs"><figcaption><span>HttpBilibili.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BiliBili.Danmaku.Utils</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HttpBilibili</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> HttpClient _httpClient;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HttpBilibili</span>(<span class="params">HttpClient client</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _httpClient = client;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Task&lt;Stream&gt; <span class="title">GetDanmakuByCid</span>(<span class="params"><span class="built_in">int</span> cid</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> _httpClient.GetStreamAsync(<span class="string">$&quot;https://api.bilibili.com/x/v1/dm/list.so?oid=<span class="subst">&#123;cid&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cs"><figcaption><span>Startup.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    services.AddControllers();</span><br><span class="line">    services.AddHttpClient&lt;HttpBilibili&gt;().ConfigurePrimaryHttpMessageHandler(() =&gt;</span><br><span class="line">        <span class="keyword">new</span> SocketsHttpHandler &#123; AutomaticDecompression = DecompressionMethods.Deflate &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cs"><figcaption><span>BiliBiliDanmakuController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> BiliBili.Danmaku.Utils;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BiliBili.Danmaku.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">&quot;api/danmaku&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BiliBiliDanmakuController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> HttpBilibili _bilibili;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BiliBiliDanmakuController</span>(<span class="params">HttpBilibili bilibili</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _bilibili = bilibili;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet(<span class="meta-string">&quot;v1&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Task&lt;Stream&gt; <span class="title">GetV1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> a = _bilibili.GetDanmakuByCid(<span class="number">1176840</span>);</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此，Http 请求部分就算是完成了后面就是反序列化的问题了。</p><h2 id="反序列化">反序列化<a class="header-anchor" href="#反序列化">➴</a></h2><p>说实话，反序列化相比上面，就简单的多了。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chatserver</span>&gt;</span>chat.bilibili.com<span class="tag">&lt;/<span class="name">chatserver</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">chatid</span>&gt;</span>1176840<span class="tag">&lt;/<span class="name">chatid</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mission</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mission</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maxlimit</span>&gt;</span>3000<span class="tag">&lt;/<span class="name">maxlimit</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">state</span>&gt;</span>0<span class="tag">&lt;/<span class="name">state</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">real_name</span>&gt;</span>0<span class="tag">&lt;/<span class="name">real_name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span>&gt;</span>e-r<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">d</span> <span class="attr">p</span>=<span class="string">&quot;44.12500,1,25,16777215,1416323487,0,af4aa003,682225690&quot;</span>&gt;</span></span><br><span class="line">        我炮还能再战500年！！！我炮还能再战500年！！！我炮还能再战500年！！！我炮还能再战500年</span><br><span class="line">    <span class="tag">&lt;/<span class="name">d</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">d</span> <span class="attr">p</span>=<span class="string">&quot;52.63100,5,18,15772458,1416575349,0,f9289c56,684620215&quot;</span>&gt;</span></span><br><span class="line">        我炮还能再战五百年★☆★☆吾等炮党愿万世轮回❤只为换取公主一世笑颜★☆★☆我炮还能再战五百</span><br><span class="line">    <span class="tag">&lt;/<span class="name">d</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">d</span> <span class="attr">p</span>=<span class="string">&quot;44.93300,5,25,16737792,1417309755,0,fb8ee8a9,693992629&quot;</span>&gt;</span></span><br><span class="line">        我炮再战500年！在弹幕里为姐姐大人加油！我炮再战500年！在弹幕里为姐姐大人加油！我炮再战500年！在弹幕里为姐姐大人加油！</span><br><span class="line">    <span class="tag">&lt;/<span class="name">d</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上面只是截取了一小段，我们需要的仅仅是 <code>d</code> 标签，复制上面的内容，利用 Visual Studio 的选择性粘贴功能，创建一个类</p><p><code>编辑</code> &gt; <code>选择性粘贴</code> &gt; <code>将XML粘贴为类</code></p><p>然后适当的修改，下面的这段代码可能和直接粘贴的差别有点大，但肯定是从那里直接修改过来的。</p><figure class="highlight cs"><figcaption><span>DanmakuXml.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel;</span><br><span class="line"><span class="keyword">using</span> System.Xml.Serialization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BiliBili.Danmaku.Model</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">SerializableAttribute</span>]</span><br><span class="line">    [<span class="meta">DesignerCategory(<span class="meta-string">&quot;code&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">XmlType(AnonymousType = true)</span>]</span><br><span class="line">    [<span class="meta">XmlRoot(<span class="meta-string">&quot;i&quot;</span>, Namespace = <span class="meta-string">&quot;&quot;</span>, IsNullable = false)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DanmakuXml</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">XmlElement(<span class="meta-string">&quot;d&quot;</span>)</span>] <span class="keyword">public</span> iD[] D &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializableAttribute</span>]</span><br><span class="line">    [<span class="meta">DesignerCategory(<span class="meta-string">&quot;code&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">XmlType(AnonymousType = true)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">iD</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">XmlAttribute(<span class="meta-string">&quot;p&quot;</span>)</span>] <span class="keyword">public</span> <span class="built_in">string</span> P &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">XmlText</span>] <span class="keyword">public</span> <span class="built_in">string</span> Value &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后对前面的 xml 解析，提前已经知道映射关系了。</p><p><img src="/assets/img/2020/Snipaste_2020-02-23_18-32-51.png" alt=""></p><p>在前面的 Http 请求部分，我把最后一次的返回类型从 <code>string</code> 改成了 <code>Stream</code> ，前面的 <code>string</code> 类型只是在测试的时候方便 Debug，改成 Stream 类型是为了优化右面的反序列化。</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;DanmakuXml&gt; <span class="title">DXml</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a = _bilibili.GetDanmakuByCid(<span class="number">1176840</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DanmakuXml(<span class="keyword">await</span> a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cs"><figcaption><span>DanmakuXml.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Xml.Serialization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BiliBili.Danmaku.Model</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">SerializableAttribute</span>]</span><br><span class="line">    [<span class="meta">DesignerCategory(<span class="meta-string">&quot;code&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">XmlType(AnonymousType = true)</span>]</span><br><span class="line">    [<span class="meta">XmlRoot(<span class="meta-string">&quot;i&quot;</span>, Namespace = <span class="meta-string">&quot;&quot;</span>, IsNullable = false)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DanmakuXml</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DanmakuXml</span>(<span class="params"></span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     从Dplayer弹幕转换</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ds&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DanmakuXml</span>(<span class="params">List&lt;DanmakuData&gt; ds</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            D = ds.Select(d =&gt; <span class="keyword">new</span> iD</span><br><span class="line">            &#123;</span><br><span class="line">                P = <span class="string">$&quot;<span class="subst">&#123;d.Time&#125;</span>,<span class="subst">&#123;(d.Type == <span class="number">2</span> ? <span class="number">4</span> : d.Type == <span class="number">1</span> ? <span class="number">5</span> : <span class="number">1</span>)&#125;</span>,25,<span class="subst">&#123;d.Color&#125;</span>,1512931469,1,354b5ade,4028451968&quot;</span>,</span><br><span class="line">                Value = d.Text</span><br><span class="line">            &#125;).ToArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     反序列化</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;s&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BilibiliDanmakuData</span>(<span class="params">Stream s</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> serializer = <span class="keyword">new</span> XmlSerializer(<span class="keyword">typeof</span>(BilibiliDanmakuData));</span><br><span class="line">            <span class="keyword">var</span> bd = (BilibiliDanmakuData) serializer.Deserialize(s);</span><br><span class="line">            D = bd.D;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">XmlElement(<span class="meta-string">&quot;d&quot;</span>)</span>] <span class="keyword">public</span> iD[] D &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>     转通用Data</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IEnumerable&lt;DanmakuData&gt; <span class="title">ToDanmakuDataList</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> D.Select(s =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> d = s.P.Split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> t = <span class="built_in">int</span>.Parse(d[<span class="number">1</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> DanmakuData</span><br><span class="line">                &#123;</span><br><span class="line">                    Time = <span class="built_in">float</span>.Parse(d[<span class="number">0</span>]),</span><br><span class="line">                    Color = <span class="built_in">int</span>.Parse(d[<span class="number">3</span>]),</span><br><span class="line">                    Type = t == <span class="number">4</span> ? <span class="number">2</span> : t == <span class="number">5</span> ? <span class="number">1</span> : <span class="number">0</span>,</span><br><span class="line">                    Author = <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    Text = s.Value</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">ToXml</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> ms = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">            <span class="keyword">var</span> x = <span class="keyword">new</span> XmlSerializer(<span class="keyword">typeof</span>(BilibiliDanmakuData));</span><br><span class="line">            x.Serialize(ms, <span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> Encoding.UTF8.GetString(ms.ToArray());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializableAttribute</span>]</span><br><span class="line">    [<span class="meta">DesignerCategory(<span class="meta-string">&quot;code&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">XmlType(AnonymousType = true)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">iD</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">XmlAttribute(<span class="meta-string">&quot;p&quot;</span>)</span>] <span class="keyword">public</span> <span class="built_in">string</span> P &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">XmlText</span>] <span class="keyword">public</span> <span class="built_in">string</span> Value &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cs"><figcaption><span>DanmakuData.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Text.Json;</span><br><span class="line"><span class="keyword">using</span> System.Text.Json.Serialization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BiliBili.Danmaku.Model</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DanmakuData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> Time &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Type &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Color &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">MaxLength(16)</span>] <span class="keyword">public</span> <span class="built_in">string</span> Author &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">MaxLength(255)</span>] <span class="keyword">public</span> <span class="built_in">string</span> Text &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">ToJson</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">            <span class="keyword">return</span> JsonSerializer.Serialize(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DanmakuData <span class="title">FromJson</span>(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">            <span class="keyword">return</span> JsonSerializer.Deserialize&lt;DanmakuData&gt;(json);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果前面还是用 <code>GetStringAsync()</code> 的话，就要用到</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;DanmakuXml&gt; <span class="title">DXml</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a = _bilibili.GetDanmakuByCid(<span class="number">1176840</span>);  <span class="comment">//这里a的类型是 Task&lt;string&gt;</span></span><br><span class="line">    <span class="keyword">using</span> StringReader sr = <span class="keyword">new</span> StringReader(<span class="keyword">await</span> a);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DanmakuXml(sr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样的话就有有一个问题，会有一个 <code>Stream</code> -&gt; <code>string</code> -&gt; <code>Stream</code> 的转换，造成不必要的资源浪费，json 反序列化的时候也是同理，用 <code>GetStreamAsync()</code> 而不是 <code>GetStringAsync()</code>。</p><p>至此，反序列化部分也已经完成了，后面需要的就是序列化，转换成其他播放器可以使用的格式。</p><p>后面的部分就比较简单了，相信一个初学者都可以顺利完成，就不再赘述了。</p><div class="page-reward"><a href="javascript:;" class="page-reward-btn tooltip-top"><div class="tooltip tooltip-east"><span class="tooltip-item">赏 </span><span class="tooltip-content"><span class="tooltip-text"><span class="tooltip-inner"><p class="reward-p"><i class="icon icon-quo-left"></i>请作者吃辣条<i class="icon icon-quo-right"></i></p><div class="reward-box"><div class="reward-box-item"><img class="reward-img" src="/assets/img/alipay.png"> <span class="reward-type">支付宝</span></div><div class="reward-box-item"><img class="reward-img" src="/assets/img/wechatpay.png"> <span class="reward-type">微信</span></div></div></span></span></span></div></a></div><div><ul class="post-copyright"><li><strong>本文作者：</strong> MonoLogueChi</li><li><strong>本文链接：</strong> <a href="https://blog.xxwhite.com/2020/bilibili-danmaku.html" title="叉叉白">https://blog.xxwhite.com/2020/bilibili-danmaku.html</a></li><li><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</li></ul></div></div><div class="article-info article-info-index"><div class="article-tag tagcloud"><i class="icon-price-tags icon"></i><ul class="article-tag-list"><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag article-tag-list-link color3">C#</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag article-tag-list-link color2">dotnet</a></li></ul></div><div class="clearfix"></div></div></div></article><nav id="article-nav"><a href="/2020/bilibili-bvid.html" id="article-nav-newer" class="article-nav-link-wrap"><i class="icon-circle-left"></i><div class="article-nav-title">BiliBili的bvid查询cid</div></a><a href="/2020/aspnetcore-vue.html" id="article-nav-older" class="article-nav-link-wrap"><div class="article-nav-title">在 .NET CORE 项目中使用 VUE</div><i class="icon-circle-right"></i></a><br><a onclick="mdpage()" target="_blank" style="cursor:pointer">获取文章MarkDown文件</a> <span style="float:right;color:#0094d5" id="/2020/bilibili-danmaku.html" class="leancloud_visitors" data-flag-title="BiliBili弹幕解析"><span class="post-meta-item-text">本文阅读量 </span><span class="leancloud-visitors-count">8848</span></span></nav><script>var mdhost="https://raw.githubusercontent.com/MonoLogueChi/blog.xxwhite.com/master/source/_posts",mdurl="2020/bilibili-danmaku.html".replace(".html",".md");function mdpage(){window.open(mdhost+"/"+mdurl)}</script><aside class="wrap-side-operation"><div class="mod-side-operation"><div class="jump-container" id="js-jump-container" style="display:none"><a href="javascript:void(0)" class="mod-side-operation__jump-to-top"><i class="icon-font icon-back"></i></a><div id="js-jump-plan-container" class="jump-plan-container" style="top:-11px"><i class="icon-font icon-plane jump-plane"></i></div></div><div class="toc-container tooltip-left"><i class="icon-font icon-category"></i><div class="tooltip tooltip-east"><span class="tooltip-item"></span> <span class="tooltip-content"><div class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#B-%E7%AB%99%E5%BC%B9%E5%B9%95%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.</span> <span class="toc-text">B 站弹幕接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Http-%E8%AF%B7%E6%B1%82"><span class="toc-number">2.</span> <span class="toc-text">Http 请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80"><span class="toc-number">2.1.</span> <span class="toc-text">基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96"><span class="toc-number">2.2.</span> <span class="toc-text">优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">反序列化</span></a></li></ol></div></span></div></div></div></aside><section id="comments"><div id="vcomment"></div><script>var valineConifg={appId:"BOnDPDiz9EeoGAC11JdnV9mw-gzGzoHsz",appKey:"gNFFgOahNl9DGsyX1WearaYO",mini:!1,avatar:"",avatar_cdn:"https://sdn.geekzu.org/avatar/",placeholder:"点击评论",pageSize:12,visitor:!0,recordIP:!0,serverURLs:"https://leancloud.xxwhite.com",version:"latest",adminEmailMd5:"a70ed099981735ebdf3d7c71dc507559",el:"#vcomment"},valineVersion=valineConifg.version,valineSrc=valineConifg.mini?"https://cdn.jsdelivr.net/npm/minivaline@"+valineVersion+"/dist/MiniValine.min.js":"https://cdn.jsdelivr.net/npm/valine@"+valineVersion+"/dist/Valine.min.js";loadScript(valineSrc,function(){var n;new(valineConifg.mini?MiniValine:Valine)(valineConifg),window.location.hash&&(n=setInterval(function(){document.getElementById(window.location.hash.replace("#",""))&&(location.href=window.location.hash,clearInterval(n))},250))})</script></section></div></div></div><footer id="footer"><div class="outer"><div id="footer-info"><div class="footer-left">&copy; 2015-2021 MonoLogueChi<br><a href="http://beian.miit.gov.cn/" target="_blank">蒙ICP备17004911号-1</a></div><div class="footer-right"><div><a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/MonoLogueChi/hexo-theme-yilia" target="_blank">Yilia</a> by Litten</div><div>本站由 <a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank"><img src="/assets/img/upyun.png" height="25px"> </a>提供CDN加速/云存储服务</div></div></div></div></footer></div><script>var yiliaConfig={mathjax:!1,isHome:!1,isPost:!0,isArchive:!1,isTag:!1,isCategory:!1,open_in_new:!1,toc_hide_index:!1,root:"/",innerArchive:!0,showTags:!1}</script><script>loadScript("/assets/main.18a6af.js"),loadScript("/assets/slider.b6b631.js")</script><script>loadScript("https://www.googletagmanager.com/gtag/js?id=UA-113200574-1",function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","UA-113200574-1")})</script><script>loadScript("https://hm.baidu.com/hm.js?893dcb25b87bcda2f682b3a6d5c537f7")</script><script async>loadScript("https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js",function(){pangu.spacingPage()})</script><div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)"><div class="tools-nav header-menu"><ul style="width:70%"><li style="width:33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li><li style="width:33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li><li style="width:33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于本站</a></li></ul></div><div class="tools-wrap"><section class="tools-section tools-section-all" q-show="innerArchive"><div class="search-wrap"><input class="search-ipt" q-model="search" type="text" placeholder="find something…"> <i class="icon-search icon" q-show="search|isEmptyStr"></i> <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i></div><div class="widget tagcloud search-tag"><p class="search-tag-wording">tag:</p><label class="search-switch"><input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags"></label><ul class="article-tag-list" q-show="showTags"><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color3">搞机</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color5">建站笔记</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color1">Unity</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color3">测试</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color5">随便水水</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color3">C#</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color4">涨姿势</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color3">软件</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color1">炎黄幼儿园</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color4">小工具</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color4">香橙派</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color4">服务器</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color5">个人电脑</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color2">dotnet</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color1">Linux</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color3">硬件</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color4">软路由</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color4">NAS</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color4">OMV</a></li><li class="article-tag-list-item"><a href="javascript:void(0)" class="js-tag color4">timeline</a></li><div class="clearfix"></div></ul></div><ul class="search-ul"><li class="search-li" q-repeat="items" q-show="isShow"><a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a><p class="search-time"><i class="icon-calendar icon"></i> <span q-text="date|dateformat"></span></p><p class="search-tag"><i class="icon-price-tags icon"></i> <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span></p></li></ul></section><section class="tools-section tools-section-friends" q-show="friends"><ul class="search-ul"><li class="search-li"><a href="https://blog.xxwhite.com/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>叉叉白</a></li><li class="search-li"><a href="https://minemine.cc/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>大姐姐的博客Minemine</a></li><li class="search-li"><a href="http://socoolapk.top/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>酷安基佬</a></li><li class="search-li"><a href="https://www.se7ensec.cn/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>Se7en</a></li><li class="search-li"><a href="https://blog.isoyu.com/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>姬长信</a></li><li class="search-li"><a href="http://staunchkai.com/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>staunchkai</a></li><li class="search-li"><a href="https://www.iszy.cc/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>随遇而安</a></li><li class="search-li"><a href="https://zsh2401.top/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>2401的晚秋咖啡</a></li><li class="search-li"><a href="https://careyq.cool" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>CareyQ</a></li><li class="search-li"><a href="https://liujunzhou.top/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>Junzhou Liu</a></li><li class="search-li"><a href="https://yi-yun.github.io/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>Yi-Yun</a></li><li class="search-li"><a href="https://www.lmcjl.com" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>LmCjl在线工具</a></li><li class="search-li"><a href="https://blogs.kainy.cn/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>Freetao’s Blog</a></li></ul></section><section class="tools-section tools-section-me" q-show="aboutme"><div class="aboutme-wrap" id="js-aboutme">叉叉白 一个小白搞机的记事本</div></section></div></div><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button> <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></body></html>